{% extends 'base.html.twig' %}
  {% block stylesheets %}
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
              integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
              crossorigin=""></script>
      <style type="text/css">
          #map { /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
              height: 350px;
              width: 330px;
          }
      </style>
  {% endblock %}
{% block body %}
    <div class="ctn detailsCtn">
        <h1 class="detailsTitle">{{ article.title }} <br> <span class="detailsSubtitle grey"> par {{ article.author }} | publié le {{ article.updatedAt|date('d/m/Y') }} {# AJOUTER DATE DANS BDD #}</span>
        </h1>

        <p class="detailsContent">{{ article.content }}</p>
        <div class="detailsPhotoCtn">
            <img class="detailsPhoto" src="{{ article.photo }}" alt="Illustration Article {{ article.title }}">
            {% if article.photoB %}
                <img class="detailsPhoto" src="{{ article.photoB }}" alt="Illustration Article {{ article.title }}">
            {% endif %}
            {% if article.photoC %}
                <img class="detailsPhoto" src="{{ article.photoC }}" alt="Illustration Article {{ article.title }}">
            {% endif %}
        </div>

        {% if article.needs %}
            <div class="needsCtn">
                <h3 class="needsTitle">Nos besoins</h3>
                <p class="needsBody">{{ article.needs }}</p>
                <a class="btn loginBtn" id="helpLink" href="#">Je peux aider !</a>
            </div>
        {% endif %}

        <h3 id="comment" class="commentTitle">Commentaires</h3>
        <div class="articleCommentCtn">
            <div class="detailsComCtn">
                {% for comment in article.comments %}
                    <div class="profileCom">
                        {% if comment.author.avatar %}
                            {% set user = comment.author %}
                            <img id="avatarCom" src="{{ vich_uploader_asset(user, 'avatarFile') }}">
                        {% endif %}
                        <span id="authorCom" class="green"> {{ comment.author }}</span>
                    </div>
                    <p class="grey comment">{{ comment.comment }}</p>
                    <div class="commentMenu">
                        <li class="nav-item dropdown" id="comMenu">
                            <a href="#" id="navbarDropdown" role="button"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-cog" id="comMenuIcon" aria-hidden="true"></i>
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                {% if app.user is same as (comment.author) %}
                                    {% include '/default/_delete_comment.html.twig' %}
                                    <a class="dropdown-item"
                                       href="{{ path('comment_edit', {'id': comment.id}) }}">Modifier</a> {# TO DO : AJOUTER MODIFICATION DE COMMENTAIRE #}
                                {% else %}
                                    <a class="dropdown-item"
                                       href="{{ path('report_comment', {'id': comment.id}) }}">Signaler</a>
                                {% endif %}
                            </div>
                        </li>
                    </div>
                    <hr class="commentLine">
                {% endfor %}
            </div>

            {% if app.user %}
                <h3 class="needsTitle comTitle">Laisser un commentaire</h3>
                {{ form_start(form) }}
                {{ form_label(form.comment, 'Votre message') }}
                {{ form_widget(form.comment) }}
                <button class="loginBtn btn sendComment">{{ button_label|default('Envoyer !') }}</button>
                {{ form_end(form) }}
            {% else %}
                <p>
                    <a class="detailsLink" href="{{ path('app_login') }}"> Connectez-vous
                    </a>
                    pour laisser un commentaire
                </p>
            {% endif %}
        </div>

        <div class="articleSideBar">
            <div class="detailsCatCtn">
                <p class="detailsCat"><i class="fa fa-folder-open" aria-hidden="true"></i>
                    Catégorie(s) : <br>
                    {% for category in article.category %}
                    <span class="detailsCatName">{{ category.name | upper }}</span></p>
                {% endfor %}
            </div>
            <h4 class="needsTitle">Lieu : </h4>
            <p>{{ article.address }}</p>
            <div class="map">
                <div id="map" data-lat="{{ article.lat }}" data-lng="{{ article.lng }}">
                </div>
            </div>
            <div class="detailsMapLink">
                <a class="detMapLink" href="{{ path('map') }}">Voir la map</a>
            </div>
            <h4 class="needsTitle">Partager : </h4> {# AJOUTER FONCTION DE PARTAGE VERS RESEAU #}
            <a class="instagram" href="#"><i class="fa fa-instagram"></i></a>
            <a class="facebook" href="#"><i class="fa fa-facebook"></i></a>
            <a class="instagram" href="#"><i class="fa fa-pinterest"></i></a>
            <a class="instagram" href="#"><i class="fa fa-twitter"></i></a>

            {% if article.author != "Kids & Family" %} {# TO DO : OPTIMISER AVEC ROLE ADMIN ? #}
            <div class="report">
                <p class="reportTitle">Contenu inapproprié ?</p>
                <a class="red bold" href="{{ path('report', {'id': article.id}) }}">Signaler cette publication</a>
            </div>
        </div>
        {% endif %}

        {% if article.telephone or article.email or article.website %}
            <div class="articleContact">
                {% if article.telephone %}
                <p class="articleContactBody"><i class="fas fa-phone-alt contactIcon"></i> 0{{ article.telephone }} <br>
                    {% endif %}
                    {% if article.email %}
                        <i class="fa fa-envelope contactIcon" aria-hidden="true"></i>
                        {{ article.email }} <br>
                    {% endif %}
                    {% if article.website %}
                    <i class="fas fa-globe contactIcon"></i> {{ article.website }}</p>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/places.js@1.19.0"></script>

    <script type="text/javascript">
        // On initialise la latitude et la longitude de Clermont Ferrand (centre de la carte)
        var lat = {{ article.lat }};
        var lon = {{ article.lng }};
        var macarte = null;
        // Nous initialisons une liste de marqueurs
        var villes = {
            "Paris": {"lat": 48.852969, "lon": 2.349903},
            "Brest": {"lat": 48.383, "lon": -4.500},
            "Quimper": {"lat": 48.000, "lon": -4.100},
            "Bayonne": {"lat": 43.500, "lon": -1.467},
            "Lyon": {"lat": 45.7628, "lon": 4.8706}
        };

        // Fonction d'initialisation de la carte
        function initMap() {
            let macarte = document.querySelector('#map')
            if (macarte === null){
                return
            }
            // Définir la variable pointant au centre
            let center = [macarte.dataset.lat, macarte.dataset.lng]
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView(center, 13);
            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, Mapbox
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © OpenStreetMap/ODbL - rendu OSM France',
                minZoom: 10,
                maxZoom: 22
            }).addTo(macarte);
            // Ajout de marker
           L.marker(center).addTo(macarte);
        }

        window.onload = function () {
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
        };
    </script>

{% endblock %}
